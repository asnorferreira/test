// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Conversation {
  id             String   @id @default(cuid())
  conversationId String   @unique
  channel        String   // whatsapp, voice, etc
  campaignId     String?
  tenantId       String   @default("demo")
  status         String   @default("active") // active, closed
  lastAnalysisId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  messages      Message[]
  analyses      CoachAnalysis[]
  helenaWebhooks HelenaWebhook[]

  @@index([conversationId])
  @@index([tenantId])
  @@index([status])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  author         String   // client, agent
  text           String   @db.Text
  timestamp      DateTime
  type           String   @default("text") // text, image, audio, etc
  metadata       Json?    // Additional metadata from Helena
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
}

model CoachAnalysis {
  id             String   @id @default(cuid())
  conversationId String
  turnId         String
  checklist      Json?    // Array of checklist items
  suggestions    Json?    // Array of suggestions
  blockers       Json?    // Array of blockers
  nudges         Json?    // Array of nudges
  nextAction     String?  @db.Text
  aiProvider     String?  // gemini, openai, etc
  aiModel        String?
  rawResponse    Json?    // Full AI response for debugging
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([turnId])
  @@index([createdAt])
}

model HelenaWebhook {
  id        String   @id @default(cuid())
  event     String   // message:created, etc
  data      Json     // Full webhook payload
  processed Boolean  @default(false)
  error     String?  @db.Text
  conversationId String?
  createdAt DateTime @default(now())

  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([processed])
  @@index([createdAt])
  @@index([conversationId])
}


