generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ai_suggestions {
  id                   String                @id
  content              String
  createdAt            DateTime              @default(now())
  eventId              String
  type                 SuggestionType
  conversation_events  conversation_events   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  suggestion_feedbacks suggestion_feedbacks?
}

model audit_logs {
  id        String   @id
  userId    String
  userEmail String
  action    String
  targetId  String
  tenantId  String
  details   Json?
  createdAt DateTime @default(now())
}

model campaigns {
  id                String              @id
  name              String
  createdAt         DateTime            @default(now())
  tenantId          String
  channel           String?
  status            CampaignStatus      @default(DRAFT)
  aiEnabled         Boolean             @default(false)
  aiProvider        String?
  aiModel           String?
  tenants           tenants             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations     conversations[]
  negotiation_rules negotiation_rules[]
  pillars           pillars[]
  policies          policies[]
  scripts           scripts[]

  @@unique([tenantId, name])
}

model coaching_snapshots {
  id             String        @id
  payload        Json
  createdAt      DateTime      @default(now())
  conversationId String
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model connectors {
  id             String   @id
  provider       String
  name           String
  encryptedToken String
  createdAt      DateTime @default(now())
  tenantId       String
  tenants        tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
}

model conversation_analyses {
  id             String        @id
  finalScore     Float
  adherenceRate  Float
  metrics        Json
  completedAt    DateTime      @default(now())
  conversationId String        @unique
  tenantId       String
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model conversation_events {
  id             String           @id
  author         String
  text           String
  timestamp      DateTime
  conversationId String
  ai_suggestions ai_suggestions[]
  conversations  conversations    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model conversations {
  id                    String                 @id
  externalId            String
  channel               String
  startedAt             DateTime               @default(now())
  endedAt               DateTime?
  campaignId            String
  tenantId              String
  coaching_snapshots    coaching_snapshots[]
  conversation_analyses conversation_analyses?
  conversation_events   conversation_events[]
  campaigns             campaigns              @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, externalId])
}

model negotiation_rules {
  id                    String    @id
  maxDiscountPercentage Int?
  maxInstallments       Int?
  minDownPayment        Int?
  forbiddenTerms        String[]
  createdAt             DateTime  @default(now())
  campaignId            String
  tenantId              String
  campaigns             campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model pillars {
  id          String    @id
  name        String
  description String?
  weight      Int       @default(1)
  createdAt   DateTime  @default(now())
  campaignId  String
  tenantId    String
  campaigns   campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model policies {
  id             String         @id
  version        Int
  body           Json
  isActive       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  campaignId     String
  publishedBy    String?
  tenantId       String
  lastTrainedAt  DateTime?
  trainingStatus TrainingStatus @default(NOT_TRAINED)
  campaigns      campaigns      @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, version])
}

model scripts {
  id         String    @id
  category   String
  body       String
  version    Int       @default(1)
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  campaignId String
  tenantId   String
  campaigns  campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model suggestion_feedbacks {
  id             String           @id
  rating         SuggestionRating
  comment        String?
  createdAt      DateTime         @default(now())
  suggestionId   String           @unique
  userId         String
  ai_suggestions ai_suggestions   @relation(fields: [suggestionId], references: [id], onDelete: Cascade)
}

model tenants {
  id                String       @id
  slug              String       @unique
  name              String
  createdAt         DateTime     @default(now())
  widgetEnabled     Boolean      @default(false)
  defaultAiProvider String?
  defaultAiModel    String?
  campaigns         campaigns[]
  connectors        connectors[]
  users             users[]
}

model users {
  id           String     @id
  email        String
  displayName  String?
  role         UserRole   @default(ATENDENTE)
  status       UserStatus @default(ACTIVE)
  passwordHash String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  tenantId     String
  tenants      tenants    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum SuggestionRating {
  GOOD
  BAD
  NEUTRAL
}

enum SuggestionType {
  SCRIPT
  ACTION
  ALERT
}

enum TrainingStatus {
  NOT_TRAINED
  PENDING
  COMPLETED
  FAILED
}

enum UserRole {
  ADMIN
  SUPERVISOR
  ATENDENTE
  QA
}

enum UserStatus {
  PENDING
  ACTIVE
  DISABLED
}

// ============================================
// Modelos para integração com Helena e N8N
// ============================================

model Conversation {
  id             String   @id @default(cuid())
  conversationId String   @unique
  channel        String   // whatsapp, voice, etc
  campaignId     String?
  tenantId       String   @default("demo")
  status         String   @default("active") // active, closed
  lastAnalysisId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  messages      Message[]
  analyses      CoachAnalysis[]
  helenaWebhooks HelenaWebhook[]

  @@index([conversationId])
  @@index([tenantId])
  @@index([status])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  author         String   // client, agent
  text           String   @db.Text
  timestamp      DateTime
  type           String   @default("text") // text, image, audio, etc
  metadata       Json?    // Additional metadata from Helena
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
}

model CoachAnalysis {
  id             String   @id @default(cuid())
  conversationId String
  turnId         String
  checklist      Json?    // Array of checklist items
  suggestions    Json?    // Array of suggestions
  blockers       Json?    // Array of blockers
  nudges         Json?    // Array of nudges
  nextAction     String?  @db.Text
  aiProvider     String?  // gemini, openai, etc
  aiModel        String?
  rawResponse    Json?    // Full AI response for debugging
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([turnId])
  @@index([createdAt])
}

model HelenaWebhook {
  id        String   @id @default(cuid())
  event     String   // message:created, etc
  data      Json     // Full webhook payload
  processed Boolean  @default(false)
  error     String?  @db.Text
  conversationId String?
  createdAt DateTime @default(now())

  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([processed])
  @@index([createdAt])
  @@index([conversationId])
}
