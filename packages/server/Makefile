# ==============================================================================
# INTERMEDIUS BACKEND - MAKEFILE
# ==============================================================================
# Este arquivo unifica os comandos mais comuns para o desenvolvimento do monorepo.
#
# Comandos disponÃ­veis:
#   make setup          - Instala todas as dependÃªncias do projeto.
#   make start-dev      - Inicia todos os serviÃ§os (gateway, ingestor, policy, worker) em modo dev.
#   make start-gateway  - Inicia apenas o api-gateway.
#   make start-ingestor - Inicia apenas o ingestor.
#   make start-policy   - Inicia apenas o policy-service.
#   make start-worker   - Inicia apenas o worker.
#   make build          - Compila todos os serviÃ§os para produÃ§Ã£o.
#   make test           - Roda todos os testes unitÃ¡rios (*.spec.ts).
#   make test-cov       - Roda os testes unitÃ¡rios e gera o relatÃ³rio de cobertura.
#   make test-e2e       - Roda todos os testes E2E (*.e2e-spec.ts) para todos os apps.
#   make test-e2e-app app=<appName> - Roda testes E2E apenas para um app especÃ­fico (ex: make test-e2e-app app=api-gateway).
#   make lint           - Analisa e corrige o cÃ³digo com ESLint.
#   make db-migrate     - Executa as migraÃ§Ãµes do Prisma.
#   make db-seed        - Popula o banco de dados com dados iniciais (definidos em seed.ts).
#   make db-studio      - Abre o Prisma Studio.
#   make docker-build   - ConstrÃ³i as imagens Docker definidas no docker-compose.yml.
#   make docker-up      - Sobe os containers (Postgres, Redis, Apps) em modo detached.
#   make docker-down    - Para e remove os containers definidos no docker-compose.yml.
#   make docker-logs    - Exibe os logs dos containers em tempo real.
#   make docker-restart - Reinicia todos os containers.
# ==============================================================================

# Silencia o output dos comandos, exceto para echoes explÃ­citos
.SILENT:

# Define PNPM como gerenciador de pacotes
PNPM = pnpm

# --- Comandos de InstalaÃ§Ã£o e Setup ---
setup:
	@echo "ğŸ“¦ Instalando dependÃªncias com PNPM..."
	$(PNPM) install

# --- Comandos de Desenvolvimento ---
start-dev:
	@echo "ğŸš€ Iniciando todos os serviÃ§os em modo de desenvolvimento (API Gateway, Ingestor, Policy Service, Worker)..."
	$(PNPM) run start:dev

start-gateway:
	@echo "ğŸš€ Iniciando API Gateway em modo de desenvolvimento..."
	$(PNPM) run start:dev:gateway

start-ingestor:
	@echo "ğŸš€ Iniciando Ingestor em modo de desenvolvimento..."
	$(PNPM) run start:dev:ingestor

start-policy:
	@echo "ğŸš€ Iniciando Policy Service em modo de desenvolvimento..."
	$(PNPM) run start:dev:policy

start-worker:
	@echo "ğŸš€ Iniciando Worker em modo de desenvolvimento..."
	$(PNPM) run start:dev:worker

# --- Comandos de Build ---
build:
	@echo "ğŸ“¦ Compilando todos os serviÃ§os para produÃ§Ã£o..."
	$(PNPM) run build:all

# --- Comandos de Teste ---
test:
	@echo "ğŸ§ª Executando testes unitÃ¡rios (*.spec.ts)..."
	$(PNPM) run test

test-cov:
	@echo "ğŸ§ª Executando testes unitÃ¡rios e gerando relatÃ³rio de cobertura..."
	$(PNPM) run test:cov

test-e2e:
	@echo "ğŸš¦ Executando TODOS os testes End-to-End (*.e2e-spec.ts)..."
	$(PNPM) run test:e2e

# Permite rodar E2E para um app especÃ­fico: make test-e2e-app app=api-gateway
test-e2e-app:
	@echo "ğŸš¦ Executando testes End-to-End para o app: $(app)..."
	@[ "${app}" ] || ( echo "Erro: Especifique o app. Ex: make test-e2e-app app=api-gateway"; exit 1 )
	$(PNPM) run test:e2e:$(app)

# --- Comandos de Qualidade de CÃ³digo ---
lint:
	@echo "ğŸ¨ Analisando e corrigindo o cÃ³digo com ESLint..."
	$(PNPM) run lint

# --- Comandos de Banco de Dados (Prisma) ---
db-migrate:
	@echo "ğŸ—„ï¸ Executando migraÃ§Ãµes do banco de dados (Prisma)..."
	$(PNPM) run prisma:migrate

db-seed:
	@echo "ğŸŒ± Populando o banco de dados com dados iniciais (libs/prisma/seeds/seed.ts)..."
	$(PNPM) run seed

db-studio:
	@echo "ğŸ” Abrindo o Prisma Studio..."
	$(PNPM) run prisma:studio

# --- Comandos do Docker ---
docker-build:
	@echo "ğŸ³ Construindo as imagens Docker para produÃ§Ã£o (usando docker-compose.yml)..."
	docker-compose build

docker-up:
	@echo "ğŸš€ Subindo os containers (Postgres, Redis, Apps) com Docker Compose em modo detached..."
	docker-compose up -d

docker-down:
	@echo "ğŸ›‘ Parando e removendo os containers definidos no docker-compose.yml..."
	docker-compose down

docker-logs:
	@echo "ğŸ“œ Exibindo logs dos containers em tempo real (Ctrl+C para sair)..."
	docker-compose logs -f

docker-restart: docker-down docker-up
	@echo "ğŸ”„ Reiniciando todos os containers Docker..."

.PHONY: setup start-dev start-gateway start-ingestor start-policy start-worker build test test-cov test-e2e test-e2e-app lint db-migrate db-seed db-studio docker-build docker-up docker-down docker-logs docker-restart