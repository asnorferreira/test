generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

model User {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  passwordHash String
  role         Role      @default(USER)
  referredById String?
  // CORREÇÃO 1: Adicionar nome explícito "UserReferrals"
  referredBy   Affiliate? @relation("UserReferrals", fields: [referredById], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  // Relacionamento 1:1 de volta, sem fields/references
  affiliate Affiliate?
}

model Affiliate {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])
  code          String    @unique
  clicks        Int       @default(0)
  signups       Int       @default(0)
  // CORREÇÃO 1: Usar o mesmo nome de relacionamento
  usersReferred User[]    @relation("UserReferrals") 
  createdAt     DateTime  @default(now())
  // CORREÇÃO 2: Adicionar o campo de volta para ReferralVisit
  visits ReferralVisit[] 
}

model ReferralVisit {
  id          String   @id @default(cuid())
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id])
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())
}